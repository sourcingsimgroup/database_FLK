<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SIM DATABASE FLK</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f7fa;
    }

    th { position: relative; white-space: nowrap; }

    .filter-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
    }

    .filter-container {
      position: absolute;
      background: #ffffff;
      border: 1px solid #ccc;
      padding: 12px;
      max-height: 240px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border-radius: 12px;
      z-index: 9999;
      display: none;
      width: 240px;
      font-size: 14px;
    }

    .filter-container label {
      display: inline-block;
      background-color: #f1f1f1;
      border-radius: 50px;
      padding: 6px 12px;
      margin: 4px 4px 6px 0;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.2s ease-in-out;
    }

    .filter-container label:hover {
      background-color: #e0e0e0;
    }

    .filter-container input[type="checkbox"] {
      margin-right: 6px;
      transform: scale(1.2);
    }

    .filter-search {
      padding: 6px 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      width: 100%;
    }

    .select-all-btn, .clear-all-btn {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border-radius: 20px;
      padding: 4px 12px;
      border: none;
      font-size: 12px;
      margin-bottom: 10px;
      margin-right: 5px;
    }

    .select-all-btn:hover, .clear-all-btn:hover {
      background-color: #0056b3;
    }

    .btn-download {
      margin: 8px 8px 20px 0;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      background-color: #28a745;
      font-weight: bold;
    }

    .btn-download:hover {
      background-color: #218838;
    }

    #logoutBtn {
      float: right;
      padding: 6px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #c82333;
    }

    #loginHeader {
      background-color: #003366;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    #loginSection {
      background-color: white;
      padding: 40px 50px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      width: 320px;
      text-align: center;
      margin: 120px auto 0 auto;
    }

    #loginSection input[type="email"],
    #loginSection input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      margin: 8px 0;
      border: 2px solid #003366;
      border-radius: 8px;
      font-size: 16px;
    }

    #loginSection button {
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      width: 110%;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    #loginSection button:hover {
      background-color: #00509e;
    }

    #loginMsg {
      margin-top: 16px;
      font-weight: 600;
      color: red;
    }

    #sheetTable_wrapper {
      width: 100%;
      overflow-x: auto;
      font-size: 14px;
    }

    table.dataTable tbody td {
      padding: 10px 8px;
      line-height: 1.4;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dataTables_wrapper .dataTables_paginate {
      padding-top: 10px;
    }

    #dataSection h2 {
      margin-top: 60px;
      color: #003366;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      z-index: 99999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="loginSection" style="display:none;">
  <div id="loginHeader">SIM Database Form Lamaran Kerja</div>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Password"><br><br>
  <button onclick="submitLogin()">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="dataSection" style="display:none; padding: 0 30px;">
  <h2>SIM Database Form Lamaran Kerja <button id="logoutBtn" onclick="submitLogout()">Logout</button></h2>
  <button class="btn-download" id="downloadAll">Download Semua Data (Excel)</button>
  <button class="btn-download" id="downloadFiltered">Download Data yang Difilter (Excel)</button>

  <table id="sheetTable" class="display nowrap" style="width:100%">
    <thead><tr id="columnHeaders"></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Overlay Loading Spinner -->
<div id="loadingOverlay" style="display:none;">
  <div class="spinner"></div>
  <p id="loadingText" style="color:white; font-weight:bold; margin-top: 12px;">Harap menunggu 10 detik untuk memuat data</p>
</div>

<script>
let table;
let globalHeaders = [];
let filters = {};

document.addEventListener("DOMContentLoaded", function () {
  const cachedSheetName = sessionStorage.getItem("sheetName");
  if (cachedSheetName) {
    $('#loginSection').hide();
    $('#dataSection').show();
    showLoading();
    google.script.run.withSuccessHandler(loadCSV).getCsvUrl(cachedSheetName);
    return;
  }

  google.script.run.withSuccessHandler(res => {
    if (res.loggedIn) {
      $('#loginSection').hide();
      $('#dataSection').show();
      showLoading();
      google.script.run.withSuccessHandler(loadCSV).getCsvUrl(res.sheetName);
    } else {
      hideLoading();
      $('#loginSection').show();
      $('#dataSection').hide();
    }
  }).getSession();
});

function submitLogin() {
  const email = $('#email').val();
  const password = $('#password').val();
  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      sessionStorage.setItem("sheetName", res.sheetName);
      $('#loginSection').hide();
      $('#dataSection').show();
      showLoading();
      google.script.run.withSuccessHandler(loadCSV).getCsvUrl(res.sheetName);
    } else {
      $('#loginMsg').text('Login gagal. Periksa email atau password.');
    }
  }).login(email, password);
}

function submitLogout() {
  google.script.run.withSuccessHandler(() => {
    sessionStorage.removeItem("sheetName");
    if ($.fn.DataTable.isDataTable('#sheetTable')) {
      $('#sheetTable').DataTable().clear().destroy();
    }
    $('#columnHeaders').empty();
    $('#sheetTable tbody').empty();
    $('#dataSection').hide();
    $('#loginMsg').text('');
    $('#email').val('');
    $('#password').val('');
    $('#loginSection').show();
  }).logout();
}

function showLoading() {
  $('#loadingOverlay').show();
  let secondsLeft = 10;
  $('#loadingText').text(`Harap menunggu ${secondsLeft} detik untuk memuat data`);
  const interval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft > 0) {
      $('#loadingText').text(`Harap menunggu ${secondsLeft} detik untuk memuat data`);
    } else {
      clearInterval(interval);
      $('#loadingOverlay').hide();
    }
  }, 1000);
}

function hideLoading() {
  $('#loadingOverlay').hide();
}

function loadCSV(sheetUrl) {
  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    complete: function (results) {
      hideLoading();
      let data = results.data.filter(row => Object.values(row).some(v => v));
      if (data.length === 0) return alert("Data kosong");
      const headers = Object.keys(data[0]);
      globalHeaders = headers;
      filters = {};
      $('#columnHeaders').empty();

      headers.forEach((header, i) => {
        $('#columnHeaders').append(`
          <th>${header}
            <button class="filter-btn" data-col="${i}">&#x25BC;</button>
            <div class="filter-container" id="filter-${i}">
              <input type="text" class="filter-search" placeholder="Cari..."><br>
              <button class="select-all-btn" data-col="${i}">Select All</button>
              <button class="clear-all-btn" data-col="${i}">Clear All</button><br><br>
            </div>
          </th>
        `);
        filters[i] = new Set();
      });

      table = $('#sheetTable').DataTable({
        data: data,
        columns: headers.map(h => {
          if (h.toLowerCase().includes("upload cv")) {
            return {
              data: h,
              render: function(data) {
                if (!data) return "";
                return `<a href="${data}" target="_blank">Download CV</a>`;
              }
            };
          } else {
            return { data: h };
          }
        }),
        ordering: false,
        pageLength: 50,
        responsive: true,
        dom: 'lrtip',
        scrollX: true,
        scrollY: "500px",
        scrollCollapse: true,
        fixedHeader: true
      });

      headers.forEach((header, colIdx) => {
        const $container = $(`#filter-${colIdx}`);
        let colValues = [...new Set(data.map(row => header.toLowerCase().includes("timestamp") ? formatDateDMY(row[header]) : row[header]).filter(Boolean))];
        colValues.forEach(val => {
          const safeVal = $('<div>').text(val).html();
          $container.append(`<label><input type="checkbox" value="${safeVal}" checked> ${safeVal}</label><br>`);
          filters[colIdx].add(val);
        });

        $container.on('change', 'input[type="checkbox"]', function () {
          const val = this.value;
          this.checked ? filters[colIdx].add(val) : filters[colIdx].delete(val);
          table.draw();
        });

        $container.on('click', '.select-all-btn', function () {
          $container.find('input[type="checkbox"]').prop('checked', true);
          filters[colIdx] = new Set($container.find('input[type="checkbox"]').map(function () { return this.value; }).get());
          table.draw();
        });

        $container.on('click', '.clear-all-btn', function () {
          $container.find('input[type="checkbox"]').prop('checked', false);
          filters[colIdx].clear();
          table.draw();
        });

        $container.on('input', '.filter-search', function () {
          const term = $(this).val().toLowerCase();
          $container.find('label').each(function () {
            $(this).toggle($(this).text().toLowerCase().includes(term));
          });
        });
      });

      $.fn.dataTable.ext.search.push(function (settings, dataRow, dataIndex) {
        const rowData = table.row(dataIndex).data();
        for (const colIdx in filters) {
          const header = headers[colIdx];
          if (filters[colIdx].size === 0) continue;
          if (header.toLowerCase().includes("timestamp")) {
            const dateOnly = formatDateDMY(rowData[header]);
            if (!filters[colIdx].has(dateOnly)) return false;
          } else {
            if (!filters[colIdx].has(rowData[header])) return false;
          }
        }
        return true;
      });

      $('.filter-btn').on('click', function (e) {
        e.stopPropagation();
        const col = $(this).data('col');
        $('.filter-container').hide();
        const $filter = $(`#filter-${col}`);
        if (!$filter.parent().is('body')) {
          $filter.appendTo('body');
        }
        const btnOffset = $(this).offset();
        const btnHeight = $(this).outerHeight();
        $filter.css({
          top: btnOffset.top + btnHeight + 4 + 'px',
          left: btnOffset.left + 'px',
          display: 'block',
          position: 'absolute',
          zIndex: 9999
        });
      });

      $(document).on('click', function (e) {
        if (!$(e.target).closest('.filter-btn, .filter-container').length) {
          $('.filter-container').hide();
        }
      });

      $('#downloadAll').on('click', () => downloadExcel(data, headers, 'semua_data.xlsx'));
      $('#downloadFiltered').on('click', () => {
        const filteredData = table.rows({filter: 'applied'}).data().toArray();
        downloadExcel(filteredData, headers, 'data_terfilter.xlsx');
      });

      function downloadExcel(dataArray, headers, filename) {
        const ws_data = [headers];
        dataArray.forEach(row => {
          const rowArr = headers.map(h => row[h] || "");
          ws_data.push(rowArr);
        });
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, filename);
      }

      function formatDateDMY(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d)) return "";
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }
    }
  });
}
</script>
</body>
</html>
